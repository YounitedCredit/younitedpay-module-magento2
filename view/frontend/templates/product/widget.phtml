<?php
/**
 * Copyright since 2022 Younited Credit
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE.md.
 * It is also available through the world-wide-web at this URL:
 * https://opensource.org/licenses/AFL-3.0
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to tech@202-ecommerce.com so we can send you a copy immediately.
 *
 * @author     202 ecommerce <tech@202-ecommerce.com>
 * @copyright 2022 Younited Credit
 * @license   https://opensource.org/licenses/AFL-3.0  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * @var $block \YounitedCredit\YounitedPay\Block\Product\Widget
 */
?>
<?php $product = $block->getProduct() ?>
<?php if ($block->isEnabled() && $product && $product->getId() && $product->getTypeId() != 'grouped'): ?>
    <?php $installments = $block->getInstallments($product) ?>
    <?php $defaultMaturity = 0 ?>
    <?php $defaultInstallment = 0 ?>
    <div class="younitedpay-widget-root" id="yp-widget"
         data-price="<?= $block->escapeHtml($block->getWidgetProductPrice($product)) ?>"
         data-type="<?= $block->escapeHtml($product->getTypeId()) ?>"
        <?php if (empty($installments)): ?> style="display: none"<?php endif ?>>
        <div id="younited_block">
            <img src="<?= $block->escapeHtml($block->getImageSrc('logo-younitedpay-btn.png')) ?>"
                 alt="<?= $block->escapeHtml(__("Younited Pay")) ?>">
            <div id="yp-current-maturities">
                <?php $i = 0; ?>
                <?php foreach ($installments as $installment => $amount): ?>
                    <?php $defaultMaturity = ($i == 0) ? $amount['monthlyInstallmentAmount'] : $defaultMaturity; ?>
                    <?php $defaultInstallment = ($i == 0) ? $installment : $defaultInstallment; ?>
                    <div class="maturity_installment <?= ($i == 0) ? 'selected' : '' ?>"
                         id="maturity_installment<?= $block->escapeHtml($installment) ?>"
                         data-key="<?= $block->escapeHtml($installment) ?>"
                         data-maturity="<?= $block->escapeHtml($amount['monthlyInstallmentAmount']) ?>">
                        <span><?= $block->escapeHtml($installment) ?>x</span>
                    </div>
                    <?php $i++; ?>
                <?php endforeach; ?>
            </div>
            <div class="yp-current-installment">
                <b><span><span id="yp-maturity"><?= $block->escapeHtml($defaultMaturity) ?></span>€</span></b>
                <span id="yp-installment">x<?= $block->escapeHtml($defaultInstallment) ?></span>
            </div>
        </div>
        <div id="younited_popupzone" style="display:none;">
            <div class="popup-content">
                <button id="yp-close-popup">x</button>
                <div class="yp-left">
                    <img class="yp-popup-logo" alt="youpay"
                         src="<?= $block->escapeHtml($block->getImageSrc('logo-younitedpay.png')) ?>">
                    <div class="yp-left-title">
                        <h3><?= $block->escapeHtml(__("Simple")) ?>.</h3>
                        <h3><?= $block->escapeHtml(__("Instant")) ?>.</h3>
                        <h3><?= $block->escapeHtml(__("Secured")) ?>.</h3>
                    </div>
                    <div class="yp-text">
                        <?= $block->escapeHtml(__("Younited, it's never been easier")) ?><br>
                        <?= $block->escapeHtml(__("to pay in several times.")) ?>
                    </div>
                    <div class="yp-link">
                        <?= $block->escapeHtml(__("Have a question? Visit our")) ?> <a
                                href="https://www.younited-credit.com/questions-reponses"
                                target="_blank"><?= $block->escapeHtml(__("dedicated page")) ?></a>
                    </div>
                    <div class="logo-cards">
                        <img src="<?= $block->escapeHtml($block->getImageSrc('cb.png')) ?>"
                             alt="<?= $block->escapeHtml(__("Bank Card")) ?>">
                        <img src="<?= $block->escapeHtml($block->getImageSrc('visa.png')) ?>"
                             alt="<?= $block->escapeHtml(__("Visa")) ?>">
                        <img src="<?= $block->escapeHtml($block->getImageSrc('mastercard.png')) ?>"
                             alt="<?= $block->escapeHtml(__("Mastercard")) ?>">
                    </div>
                </div>
                <div class="yp-right">
                    <h4>
                        <?= $block->escapeHtml(__("Your purchase for")) ?>
                        <span id="popup-maturity">
                            <?= $block->escapeHtml($defaultMaturity) ?>
                        </span>€<?= $block->escapeHtml(__("/month with")) ?>
                        <br>
                        <span class="yp-purple"><?= $block->escapeHtml(__("Younited Pay")) ?></span>
                    </h4>
                    <ul id="yp-popup-maturities">
                        <?php $i = 0; ?>
                        <?php $defautAmount = [
                            'requestedAmount' => 0,
                            'interestsTotalAmount' => 0,
                            'creditTotalAmount' => 0,
                            'annualPercentageRate' => 0,
                            'annualDebitRate' => 0
                        ]; ?>
                        <?php foreach ($installments as $installment => $amount) : ?>
                            <?php $defautAmount = ($i == 0) ? $amount : $defautAmount ?>
                            <li class="blocks_maturities_popup <?= ($i == 0) ? 'selected' : '' ?>"
                                id="blocks_maturities_popup<?= $block->escapeHtml($installment) ?>"
                                data-key="<?= $block->escapeHtml($installment) ?>"
                                data-maturity="<?= $block->escapeHtml($amount['monthlyInstallmentAmount']) ?>"
                                data-amount="<?= $block->escapeHtml($amount['requestedAmount']) ?>"
                                data-percent="<?= $block->escapeHtml($amount['annualPercentageRate']) ?>"
                                data-debit="<?= $block->escapeHtml($amount['annualDebitRate']) ?>"
                                data-total="<?= $block->escapeHtml($amount['creditTotalAmount']) ?>"
                                data-interests="<?= $block->escapeHtml($amount['interestsTotalAmount']) ?>">
                                <span class=""><?= $block->escapeHtml($installment) ?> <?= $block->escapeHtml(
                                        __("months")
                                    ) ?></span>
                            </li>
                            <?php $i++; endforeach; ?>
                    </ul>

                    <p class="info-text">
                        <span class="yp-dark-purple"><?= $block->escapeHtml(__("Buy today and start paying")) ?></span><br>
                        <span class="yp-purple"><?= $block->escapeHtml(__("in just 30 days!")) ?></span>
                    </p>

                    <div class="yp-finance">
                        <div>
                            <p class="yp-dark-purple yp-font-normal"><?= $block->escapeHtml(__("Amount of financing")) ?></p>
                            <p class="yp-dark-purple"><span
                                        id="yp-amount"><?= $block->escapeHtml($defautAmount['requestedAmount']) ?></span>
                                €</p>
                        </div>
                        <div>
                            <p class="yp-dark-purple">+ <span class="yp-font-normal"
                                ><?= $block->escapeHtml(__("Payment cost")) ?></span></p>
                            <p class="yp-dark-purple"><span id="yp-cost"
                                ><?= $block->escapeHtml($defautAmount['interestsTotalAmount']) ?></span> €</p>
                        </div>
                        <hr/>
                        <div>
                            <p class="yp-dark-purple">= <?= $block->escapeHtml(__("Total amount owed")) ?></p>
                            <p class="yp-dark-purple"><span id="yp-total"
                                ><?= $block->escapeHtml($defautAmount['creditTotalAmount']) ?></span>€</p>
                        </div>
                    </div>

                    <div class="yp-tax">
                        <div><span class="yp-dark-purple"><?= __("Fixed APR") ?>:&nbsp;&nbsp;<span id="yp-percent"
                                ><?= $defautAmount['annualPercentageRate'] * 100 ?></span> %</span></div>
                        <div><span class="yp-dark-purple"><?= $block->escapeHtml(__("Fixed borrowing rate")) ?>:&nbsp;&nbsp;<span
                                        id="yp-debit"><?= $defautAmount['annualDebitRate'] * 100 ?></span> %</span>
                        </div>
                    </div>

                    <div class="yp-engagement">
                        <?= __("Taking out a loan is a commitment with an<br>obligation of repayment. Verify your ability<br>to repay the loan before committing.") ?>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/x-magento-init">
            {
                "*": {
                    "ypwidget" : {
                        "url": "<?= $block->getUrl('younited/ajax/maturity') ?>",
                        "loader": "<?= $block->escapeUrl($block->getViewFileUrl('images/loader-2.gif')); ?>",
                        "store": "<?= $block->getStoreCode() ?>"
                    }
                }
            }

    </script>
<?php endif; ?>


